#!/usr/bin/env bash
# Self-Reflection v1.0.0
# Continuous self-improvement for OpenClaw agents
# Author: hopyky
# License: MIT

set -euo pipefail

# Default paths
CONFIG_FILE="${HOME}/.openclaw/self-reflection.json"
STATE_FILE_DEFAULT="${HOME}/.openclaw/self-review-state.json"
MEMORY_FILE_DEFAULT="${HOME}/clawd/memory/self-review.md"
THRESHOLD_DEFAULT=60
MAX_ENTRIES_DEFAULT=5

# Load configuration
load_config() {
  if [[ -f "$CONFIG_FILE" ]]; then
    THRESHOLD=$(jq -r '.threshold_minutes // 60' "$CONFIG_FILE")
    MEMORY_FILE=$(jq -r '.memory_file // "'"$MEMORY_FILE_DEFAULT"'"' "$CONFIG_FILE" | sed "s|~|$HOME|g")
    STATE_FILE=$(jq -r '.state_file // "'"$STATE_FILE_DEFAULT"'"' "$CONFIG_FILE" | sed "s|~|$HOME|g")
    MAX_ENTRIES=$(jq -r '.max_entries_context // 5' "$CONFIG_FILE")
  else
    THRESHOLD=$THRESHOLD_DEFAULT
    MEMORY_FILE="$MEMORY_FILE_DEFAULT"
    STATE_FILE="$STATE_FILE_DEFAULT"
    MAX_ENTRIES=$MAX_ENTRIES_DEFAULT
  fi

  # Ensure directories exist
  mkdir -p "$(dirname "$MEMORY_FILE")" 2>/dev/null || true
  mkdir -p "$(dirname "$STATE_FILE")" 2>/dev/null || true
}

# Get last reflection timestamp
get_last_reflection() {
  if [[ -f "$STATE_FILE" ]]; then
    jq -r '.last_reflection // 0' "$STATE_FILE"
  else
    echo "0"
  fi
}

# Update last reflection timestamp
update_last_reflection() {
  local now
  now=$(date +%s)

  local count=0
  if [[ -f "$STATE_FILE" ]]; then
    count=$(jq -r '.reflection_count // 0' "$STATE_FILE")
  fi
  count=$((count + 1))

  jq -n --argjson ts "$now" --argjson count "$count" '{
    last_reflection: $ts,
    last_reflection_human: (now | strftime("%Y-%m-%d %H:%M:%S")),
    reflection_count: $count
  }' > "$STATE_FILE"
}

# Check if reflection is needed
cmd_check() {
  local quiet="${1:-}"
  local last_ts
  last_ts=$(get_last_reflection)

  local now
  now=$(date +%s)

  local diff_seconds=$((now - last_ts))
  local diff_minutes=$((diff_seconds / 60))

  if [[ "$last_ts" -eq 0 ]]; then
    if [[ "$quiet" == "--quiet" ]]; then
      echo "ALERT"
    else
      echo "ALERT: No reflection recorded yet. Please run self-reflection."
    fi
    return 1
  elif [[ "$diff_minutes" -ge "$THRESHOLD" ]]; then
    if [[ "$quiet" == "--quiet" ]]; then
      echo "ALERT"
    else
      echo "ALERT: Self-reflection required. Last reflection was ${diff_minutes} minutes ago."
    fi
    return 1
  else
    if [[ "$quiet" == "--quiet" ]]; then
      echo "OK"
    else
      local remaining=$((THRESHOLD - diff_minutes))
      echo "OK: Status good. Next reflection due in ${remaining} minutes."
    fi
    return 0
  fi
}

# Read recent reflections
cmd_read() {
  local count="${1:-$MAX_ENTRIES}"

  if [[ ! -f "$MEMORY_FILE" ]]; then
    echo "No reflections yet. File will be created on first log."
    return 0
  fi

  # Count entries (each entry starts with "## ")
  local total_entries
  total_entries=$(grep -c "^## " "$MEMORY_FILE" 2>/dev/null || echo "0")

  if [[ "$total_entries" -eq 0 ]]; then
    echo "No reflections recorded yet."
    return 0
  fi

  echo "=== Last $count reflections (of $total_entries total) ==="
  echo ""

  # Get last N entries using awk
  awk -v n="$count" '
    /^## / {
      entry_count++
      entries[entry_count] = ""
    }
    {
      if (entry_count > 0) {
        entries[entry_count] = entries[entry_count] $0 "\n"
      }
    }
    END {
      start = entry_count - n + 1
      if (start < 1) start = 1
      for (i = start; i <= entry_count; i++) {
        printf "%s", entries[i]
      }
    }
  ' "$MEMORY_FILE"
}

# Log a new reflection
cmd_log() {
  local tag="${1:-}"
  local miss="${2:-}"
  local fix="${3:-}"

  if [[ -z "$tag" ]] || [[ -z "$miss" ]] || [[ -z "$fix" ]]; then
    echo "Usage: self-reflection log <tag> <miss> <fix>"
    echo ""
    echo "Example:"
    echo '  self-reflection log "error-handling" "Forgot timeout" "Always add timeout=30"'
    return 1
  fi

  local timestamp
  timestamp=$(date "+%Y-%m-%d %H:%M")

  # Create file with header if it doesn't exist
  if [[ ! -f "$MEMORY_FILE" ]]; then
    cat > "$MEMORY_FILE" << 'HEADER'
# Self-Review Log

This file contains lessons learned and improvements for continuous growth.

---

HEADER
  fi

  # Append new entry
  cat >> "$MEMORY_FILE" << ENTRY

## ${timestamp} | ${tag}

**Miss:** ${miss}
**Fix:** ${fix}

---
ENTRY

  # Update state
  update_last_reflection

  echo "Reflection logged successfully."
  echo "  Tag:  $tag"
  echo "  Miss: $miss"
  echo "  Fix:  $fix"
}

# Show statistics
cmd_stats() {
  echo "=== Self-Reflection Statistics ==="
  echo ""

  # State info
  if [[ -f "$STATE_FILE" ]]; then
    local last_human
    last_human=$(jq -r '.last_reflection_human // "never"' "$STATE_FILE")
    local count
    count=$(jq -r '.reflection_count // 0' "$STATE_FILE")
    echo "Last reflection: $last_human"
    echo "Total reflections: $count"
  else
    echo "Last reflection: never"
    echo "Total reflections: 0"
  fi

  echo ""

  # Memory file stats
  if [[ -f "$MEMORY_FILE" ]]; then
    local entries
    entries=$(grep -c "^## " "$MEMORY_FILE" 2>/dev/null || echo "0")
    echo "Entries in memory: $entries"

    # Top tags
    if [[ "$entries" -gt 0 ]]; then
      echo ""
      echo "Top tags:"
      grep "^## " "$MEMORY_FILE" | sed 's/.*| //' | sort | uniq -c | sort -rn | head -5 | while read -r cnt tag; do
        echo "  $tag: $cnt"
      done
    fi
  else
    echo "Entries in memory: 0"
  fi

  echo ""
  echo "Threshold: ${THRESHOLD} minutes"
  echo "Memory file: $MEMORY_FILE"
}

# Reset timer
cmd_reset() {
  update_last_reflection
  echo "Timer reset. Next reflection due in ${THRESHOLD} minutes."
}

# Show help
show_help() {
  cat << 'EOF'
Self-Reflection v1.0.0
Continuous self-improvement for OpenClaw agents.

USAGE
  self-reflection <command> [options]

COMMANDS
  check [--quiet]              Check if reflection is due
  log <tag> <miss> <fix>       Log a new reflection
  read [n]                     Read last n reflections (default: 5)
  stats                        Show reflection statistics
  reset                        Reset the timer

EXAMPLES
  self-reflection check
  self-reflection log "api" "No error handling" "Add try/catch"
  self-reflection read 3
  self-reflection stats

CONFIGURATION
  Config file: ~/.openclaw/self-reflection.json

  {
    "threshold_minutes": 60,
    "memory_file": "~/clawd/memory/self-review.md",
    "max_entries_context": 5
  }

EOF
}

# Main
main() {
  load_config

  local command="${1:-check}"
  shift || true

  case "$command" in
    check)
      cmd_check "$@"
      ;;
    read)
      cmd_read "$@"
      ;;
    log)
      cmd_log "$@"
      ;;
    stats)
      cmd_stats
      ;;
    reset)
      cmd_reset
      ;;
    -h|--help|help)
      show_help
      ;;
    *)
      echo "Unknown command: $command"
      echo "Run 'self-reflection --help' for usage."
      exit 1
      ;;
  esac
}

main "$@"
